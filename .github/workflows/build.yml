name: build macOS, Linux, Windows

# Trigger the workflow on push or pull request
on: [push, pull_request]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This workflow contains a single job called "build"
  build:

    # Rename job "build"
    #name: App Build

    # CI skip conditions
    if: "!contains(github.event.head_commit.message, '[ci skip]')"

    # Change default timeout
    timeout-minutes: 20

    # The type of runner that the job will run on
    runs-on: ${{ matrix.os }}

    # Build matrix for different platforms
    strategy:
      matrix:
        os: [macos-10.15, ubuntu-20.04, windows-2019] # macos-11.0, macOS-11.0 - doesn't work

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    - name: Check-out repository
      uses: actions/checkout@v2

    - name: Set up non-Python dependences
      if: runner.os == 'Linux'
      run: sudo apt-get install libgfortran4

    - name: Set up Python environment
      uses: actions/setup-python@v2
      with:
          python-version: 3.7

    - name: Set up Python dependences (1/2)
      run: |
        pip install toml
        pip install requests

    - name: Declare env variables on push only
      if: github.event_name == 'push'
      shell: bash
      run: echo "BRANCH_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

    - name: Declare env variables on pull_request only
      if: github.event_name == 'pull_request'
      shell: bash
      run: echo "BRANCH_NAME=$GITHUB_HEAD_REF" >> $GITHUB_ENV

    # https://docs.github.com/en/actions/reference/environment-variables
    - name: Declare env variables on push and pull_request
      shell: bash
      run: |
        echo "APP_NAME=$(python pyproject.py tool.poetry.name)" >> $GITHUB_ENV
        echo "SCRIPTS_PATH=$(python pyproject.py ci.project.subdirs.scripts)" >> $GITHUB_ENV
        echo "DISTRIBUTION_PATH=$(python pyproject.py ci.project.subdirs.distribution)" >> $GITHUB_ENV
        echo "DOWNLOAD_PATH=$(python pyproject.py ci.project.subdirs.download)" >> $GITHUB_ENV
        echo "QTIFW_PATH=$(python pyproject.py ci.qtifw.setup.installation_path.${{ runner.os }})" >> $GITHUB_ENV
        echo "PYTHON_PACKAGES_PATH=$(python -c 'import os, pip; print(os.path.dirname(pip.__path__[0]))')" >> $GITHUB_ENV
        echo "GIT_INSTALL_URL=git+$GITHUB_SERVER_URL/$GITHUB_REPOSITORY@${{ env.BRANCH_NAME }}" >> $GITHUB_ENV

    #- name: Cache dependencies
    #  uses: actions/cache@v2
    #  with:
    #    path: |
    #      ${{ env.DOWNLOAD_PATH }}
    #      ${{ env.QTIFW_PATH }}
    #      ${{ env.PYTHON_PACKAGES_PATH }}
    #    key: ${{ matrix.os }}-${{ hashFiles('pyproject.toml') }}

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Set up Python dependences (2/2)
      run: pip install ${{ env.GIT_INSTALL_URL }}

    - name: Relink CrysFML from default Python dylib
      run: python ${{ env.SCRIPTS_PATH }}/RelinkCrysfml.py

    - name: Create freezed python app bundle
      run: python ${{ env.SCRIPTS_PATH }}/FreezeApp.py

    - name: Create app installer from freezed app bundle
      run: python ${{ env.SCRIPTS_PATH }}/MakeInstaller.py

    - name: Install and run app in test mode to create GUI test videos
      if: runner.os == 'macOS'
      run: |
        python ${{ env.SCRIPTS_PATH }}/InstallApp.py
        python ${{ env.SCRIPTS_PATH }}/RunApp.py test
        python ${{ env.SCRIPTS_PATH }}/CreateTestVideos.py ${{ env.BRANCH_NAME }}

    - name: Create zip archive of app installer
      run: python ${{ env.SCRIPTS_PATH }}/ZipArtifacts.py ${{ env.BRANCH_NAME }}

    - name: Upload zipped app installer to GitHub releases
      if: github.event_name == 'push'
      uses: ncipollo/release-action@v1
      with:
        draft: true
        prerelease: true
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "${{ env.DISTRIBUTION_PATH }}/${{ env.APP_NAME }}_*.zip,${{ env.DISTRIBUTION_PATH }}/tutorial_*.mp4"
        tag: ${{ env.BRANCH_NAME }}
        commit: ${{ env.BRANCH_NAME }}

    - name: Upload app installer repository to FTP
      if: github.event_name == 'push'
      run: python ${{ env.SCRIPTS_PATH }}/DeployFtp.py ${{ env.BRANCH_NAME }} ${{ secrets.FTP_PASSWORD }}
