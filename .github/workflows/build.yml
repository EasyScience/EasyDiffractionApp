name: build macOS, Linux, Windows

# Trigger the workflow on push or pull request
#on: [push, pull_request]
on: [push]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This workflow contains a single job called "build"
  build:

    # Rename job "build"
    #name: App Build

    # CI skip conditions
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    #if: false

    # Change default timeout
    timeout-minutes: 25

    # The type of runner that the job will run on
    runs-on: ${{ matrix.os }}

    # Build matrix for different platforms
    strategy:
      matrix:
        os: [macos-10.15, windows-2019] # [macos-10.15, ubuntu-20.04, windows-2019] # macos-11.0, macOS-11.0 - doesn't work

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    - name: Check-out repository
      uses: actions/checkout@v2

    - name: Set up non-Python dependences
      if: runner.os == 'Linux'
      run: sudo apt-get install libgfortran4

    - name: Set up Python environment
      uses: actions/setup-python@v2
      with:
          python-version: 3.7

    - name: Set up project config parser & Declare env variables
      shell: bash
      run: |
        pip install toml
        echo "SHORT_GITHUB_REF=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
        echo "PYTHON_LOCATION=$pythonLocation" >> $GITHUB_ENV
        echo "PYTHON_SITE_PACKAGES_PATH=$(python -c 'import os, pip; print(os.path.dirname(pip.__path__[0]))')" >> $GITHUB_ENV
        echo "SCRIPTS_PATH=$(python pyproject.py ci.project.subdirs.scripts)" >> $GITHUB_ENV
        echo "DOWNLOAD_PATH=$(python pyproject.py ci.project.subdirs.download)" >> $GITHUB_ENV
        echo "DISTRIBUTION_PATH=$(python pyproject.py ci.project.subdirs.distribution)" >> $GITHUB_ENV
        echo "APP_NAME=$(python pyproject.py tool.poetry.name)" >> $GITHUB_ENV
        echo "QTIFW_PATH=$(python pyproject.py ci.qtifw.setup.installation_path.${{ runner.os }})" >> $GITHUB_ENV

    - name: Cache dependencies
      uses: actions/cache@v2
      with:
        path: |
          ${{ env.PYTHON_SITE_PACKAGES_PATH }}
          ${{ env.QTIFW_PATH }}
          ${{ env.DOWNLOAD_PATH }}
        key: ${{ matrix.os }}-${{ hashFiles('pyproject.toml') }}

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Set up Python dependences
      run: |
        pip install requests
        pip install git+https://github.com/easyScience/easyDiffractionApp@DAS-294

    - name: Relink CrysFML from default Python dylib
      run: python ${{ env.SCRIPTS_PATH }}/RelinkCrysfml.py

    - name: Create freezed python app bundle
      run: python ${{ env.SCRIPTS_PATH }}/FreezeApp.py

    - name: Create app installer from freezed app bundle
      run: python ${{ env.SCRIPTS_PATH }}/MakeInstaller.py

    - name: Install and run app in test mode to create GUI test videos
      run: |
        python ${{ env.SCRIPTS_PATH }}/InstallApp.py
        python ${{ env.SCRIPTS_PATH }}/RunApp.py test
        python ${{ env.SCRIPTS_PATH }}/CreateTestVideos.py ${{ env.SHORT_GITHUB_REF }}

    - name: Create zip archive of app installer
      run: python ${{ env.SCRIPTS_PATH }}/ZipArtifacts.py ${{ env.SHORT_GITHUB_REF }}

    - name: Upload GUI test videos to GitHub repository
      if: github.head_ref == '' && runner.os == 'macOS'
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Upload GUI test videos

    - name: Upload zipped app installer to GitHub releases
      if: github.head_ref == ''
      uses: ncipollo/release-action@v1
      with:
        draft: true
        prerelease: true
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        commit: ${{ env.SHORT_GITHUB_REF }}
        tag: ${{ env.SHORT_GITHUB_REF }}
        artifacts: "${{ env.DISTRIBUTION_PATH }}/${{ env.APP_NAME }}_*.zip,${{ env.DISTRIBUTION_PATH }}/${{ env.APP_NAME }}_*.mp4"

    - name: Upload app installer repository to FTP
      if: github.head_ref == ''
      run: python ${{ env.SCRIPTS_PATH }}/DeployFtp.py ${{ env.SHORT_GITHUB_REF }} ${{ secrets.FTP_PASSWORD }}
